#!/bin/bash

# AIHub í•œ ê°œì”© ë‹¤ìš´ë¡œë“œ ë° ì²˜ë¦¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸
# - filekeyë¡œ í•˜ë‚˜ì”© ë‹¤ìš´ë¡œë“œ
# - ë‚´ë¶€ í´ë” êµ¬ì¡° íŒŒì•… í›„ *_0001.jpg/json/png ë§Œ ë‚¨ê¸°ê³  ì‚­ì œ
# - zip íŒŒì¼ì€ ìë™ ì‚­ì œë˜ë¯€ë¡œ ë”°ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ

APIKEY='EC263BEC-B54B-4B75-8383-5F48F73FA3EE'
DATASETKEY=144
WORKDIR=$(pwd)

# filekeys ë¦¬ìŠ¤íŠ¸ (ìˆœì°¨ ì²˜ë¦¬)
filekeys=(
    # ëœë“œë§ˆí¬
#   ì™„ 49994 49995 49996 50105 50106 50107 50108

    # ìœ ì 
  # ì™„ 50206 50207 50208 
  # ì™„ 50111 50112 50113 50114 50115 50116 50117 50118 50119 50120 50121 50122 50123 50124 50125 50126 50127 50128 50129 50130 50131 50132 50133 50134 50135 50136 50137 50138 50139 50140 50141 50142 50143 50144 50145 50146 50147 50148 50149 50150 50151 50152 50153 50154 50155 50156 50157 50158 50159 50160 50161 50162 50163 50164 
  # ì™„ 50052 50053 50054 50055 50056 50057 50058 50059 50060 50061 50062 50063 50064 50065 50066 50067 50068 50069 50070 50071 50072 50073 50074 
  # ë‚˜ì¤‘ì— 50075 50076 50077 50078 50079 50080 50081 50082

    # ìƒí’ˆ
  #  ì™„ 50083 50084 50085 50086 50087 50088 50089 
  # ë‚˜ì¤‘ì— ë‹¤ìš´ 50090 50091 50092 50093 50094 50095 50096 50097 50098 50099 50100 50101 50102 50103 50104
 
  # ì‚­ì œ íŒŒì¼ ê¹¨ì§ ì´ìŠˆ 63613
)

for key in "${filekeys[@]}"; do
    echo "ğŸ”½ filekey $key ë‹¤ìš´ë¡œë“œ ì¤‘..."
    # zip ë‹¤ìš´ë°–ì— ì•ˆë˜ëŠ” ë“¯.
    aihubshell -mode d -datasetkey $DATASETKEY -filekey $key -aihubapikey "$APIKEY"
    
    # .zip íŒŒì¼ íƒìƒ‰
    echo "ğŸ” [$key] ìƒˆë¡œ ìƒì„±ëœ zip íƒìƒ‰ ì¤‘..."
    zip_path=$(find "$WORKDIR" -maxdepth 5 -type f -name '*.zip' -newermt "$(date -d '5 minutes ago' '+%Y-%m-%d %H:%M:%S')" | head -n 1)
    # ëª»ì°¾ì€ ê²½ìš°
    if [[ -z "$zip_path" ]]; then
        echo "âš ï¸ [$key] zip íŒŒì¼ íƒìƒ‰ ì‹¤íŒ¨. ìŠ¤í‚µí•©ë‹ˆë‹¤."
        continue
    fi

    # unzip
    unzip_dir="${zip_path%.zip}_unzipped"
    mkdir -p "$unzip_dir"
    echo "ğŸ“‚ [$key] unzip ì¤‘... â†’ $unzip_dir"
    unzip -q "$zip_path" -d "$unzip_dir"

    # zip íŒŒì¼ ì‚­ì œ.
    rm -f "$zip_path"

    # HFë¡œ ì‹œì‘í•˜ëŠ” í•˜ìœ„í´ë” ìˆœíšŒ
    find "$unzip_dir" -type d -name "HF*" | while read -r hffolder; do
        find "$hffolder" -type f \( ! -iname '*_0001.jpg' ! -iname '*_0001.json' ! -iname '*0001.png' \) -delete
    done

    echo "âœ… filekey $key ì™„ë£Œ"
done
